

# 第二讲

## 03 架构的目的

### 笔记

1. 架构是为了解决软件复杂度提高带来的问题
2. 每种架构都能解决特定的问题，例如，异地数据存储，是因为“数据重要，不允许有闪失”，而同机房主从同步，可能会因为机房的事故，如火灾、地震等导致两个数据库数据都丢失，而异地主从同步显然能更安全

## 04 高性能复杂度

### 笔记

#### 单机复杂度

1. 时间片系统
2. 多进程多线程

#### 集群复杂度

1. 任务分配

   1. 多结点需要一个任务分配的机制（也是个服务器），需要确定分配算法、连接方式等等
   2. 流量增加，继续增加业务结点后，任务分配服务器所承受的流量是所有业务结点的流量和，此时一台任务分配服务器也不够用了，需要拓展成多结点，又会带来全局分配的问题

2. 任务分解

   当业务服务器的业务越来越复杂，性能越来越难以提高，可以考虑将复杂的业务分解成多种业务服务器

   1. 简单的系统更容易提高性能
   2. 可以针对单个子系统拓展
   3. 缺点是，增加了系统之间调用的开销、代码量的增加

## 05 高可用复杂度

### 计算高可用

同高性能集群，需要任务分配和分解

### 存储高可用

1. 数据一致性

   由于数据备份不可能完全没问题，因此会带来一致性问题

2. 高可用状态决策

   CAP定理，进行取舍

   1. 独裁式
   2. 协商式
   3. 民主式
      1. 脑裂问题

   

## 06 可拓展性复杂度

### 应对变化

   抽离稳定层和变化层

## 07 低成本、安全、规模

## 08 架构设计三原则

#### 合适原则

合适优于业界领先

#### 简单原则

结构复杂：组件数量过多

1. 出问题的概率变大
2. 改动某个组件的难度变大
3. 定位问题更困难

逻辑复杂：单个组件的逻辑过于复杂

#### 演化原则

演化优于一步到位

## 10-13 设计案例

### 1、识别复杂度

考虑前面提到的六个复杂度，判断系统的主要复杂度在哪，并进行指标的量化，如需要达到QPS1W

#### 高性能

1. 常用系统组件，如kafka、nginx等的性能量级要熟记于心

   nginx负载均衡性能是3万左右，mc的读取性能5万左右，kafka号称百万级，zookeeper写入读取2万以上，http请求访问大概在2万左右。

2. 业务系统，可通过性能测试，确立性能基线

### 高可用

写入高可用、读取高可用，需要对应用场景判断，比如“丢消息”是否可以接受

### 2、设计备选方案

1. 必须适合当前业务！合适原则！
2. 需要多个备选方案，3-5个最佳
   1. 必须做备选方案，不能只做心理评估，容易太片面
   2. 备选方案之间需要有差异，如主备方案和集群方案就是一种差异
   3. 不应该局限于熟悉的技术
   4. 不需要特别详细，将耗费巨大精力和时间，具体到技术选型即可，一些细节可以后定

### 3、评估和选择方案

1. 将所有属性做360度环评表，对于不同属性之间的差异，按照优先级进行排序

   重要的点有

   1. 业务发展
   2. 团队规模
   3. 业务发展预测
   4. 运维情况

2. 和项目各部门评审，看看各方意见，如测试、运维、开发等，重要的问题也作为环评表的属性

3. 综合环评表，总结所选方案的优缺点、缺点优化方案，以及排除其他方案的理由

### 4、详细设计

完善具体的设计，提供指导开发的文档。

设计阶段才发现备选方案不可行，需重推再来，所以要求：

1. 对所使用的技术栈有深入理解
2. 降低方案复杂度